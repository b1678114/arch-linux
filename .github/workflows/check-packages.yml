name: Verify Arch Linux Packages

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  check-packages:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Update Pacman and Install Base Packages
      run: |
        # Enable multilib repository
        sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf

        # Update pacman database and install essential tools
        pacman -Syyu
        pacman -S --noconfirm grep sed coreutils

    - name: Extract and validate packages
      run: |
        # Find all .sh files in root directory
        for file in *.sh; do
          if [ -f "$file" ]; then
            echo "Checking packages in $file..."
            
            # Extract package names from different pacman installation formats
            # Format 1: pacman -S --noconfirm \ package1 \ package2
            # Format 2: pacman -S --noconfirm package1 package2
            packages=$(grep -E "pacman -S.*--noconfirm" "$file" | 
                      sed 's/pacman -S --noconfirm//' | 
                      tr '\\' ' ' | 
                      tr -s ' ' '\n' | 
                      grep -v '^$')
            
            # Check each package
            for package in $packages; do
              if pacman -Ss "^${package}$" > /dev/null 2>&1; then
                echo "✅ Package exists: $package"
              else
                echo "❌ Package not found: $package"
                exit 1
              fi
            done
          fi
        done